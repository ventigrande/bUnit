<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Assertion of Asynchronous Changes | bUnit </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Assertion of Asynchronous Changes | bUnit ">
    <meta name="generator" content="docfx 2.56.2.0">
    <meta name="description" content="bUnit is a unit testing library for Blazor Components. You can easily define components under test in C# or Razor syntax and verify outcome using semantic HTML diffing/comparison logic. You can interact with and inspect components, trigger event handlers, provide cascading values, inject services, mock IJsRuntime, and perform snapshot testing.">
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
  
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img height="60%" id="logo" class="img" src="../..//images/blazor-logo.png" alt="bUnit">
                <span>bUnit</span>
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <div id="sponsor-button">
                <iframe src="https://github.com/sponsors/egil/button" title="Sponsor egil" height="35" width="116" style="border: 0;"></iframe>
              </div>
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="async-assertion">
<h1 id="assertion-of-asynchronous-changes">Assertion of Asynchronous Changes</h1>

<p>A test can fail if a component performs asynchronous renders. This may be due to a reason such as waiting for an asynchronous operation to complete before continuing its render life-cycle . For example, if a component is waiting for an async web service to return data to it in the <code>OnInitializedAsync()</code> life-cycle method before rendering it to the render tree.</p>
<p>You need to handle this specifically in your tests because tests execute in the test framework's synchronization context and the test renderer executes renders in its own synchronization context. If you do not, you will likely experience tests that sometimes pass, and sometimes fail.</p>
<p>bUnit comes with two methods that help to deal with this issue: the <a href="xref:Bunit.RenderedFragmentWaitForHelperExtensions.WaitForAssertion(Bunit.IRenderedFragmentBase,System.Action,System.Nullable%7BSystem.TimeSpan%7D)"><code>WaitForAssertion()</code></a> method covered on this page, and the <a class="xref" href="../../api/Bunit.RenderedFragmentWaitForHelperExtensions.html#Bunit_RenderedFragmentWaitForHelperExtensions_WaitForState_Bunit_IRenderedFragmentBase_System_Func_System_Boolean__System_Nullable_System_TimeSpan__"><code>WaitForState()</code></a> method covered on the <a class="xref" href="../interaction/awaiting-async-state.html">Awaiting an Asynchronous State Change in a Component Under Test</a> page.</p>
<p>Let's start by taking a look at the <code> WaitForAssertion</code> method in more detail.</p>
<h2 id="waiting-for-assertion-to-pass-using-waitforassertion">Waiting for Assertion to Pass Using <code>WaitForAssertion</code></h2>
<p>The <a href="xref:Bunit.RenderedFragmentWaitForHelperExtensions.WaitForAssertion(Bunit.IRenderedFragmentBase,System.Action,System.Nullable%7BSystem.TimeSpan%7D)"><code>WaitForAssertion(Action, TimeSpan?)</code></a> method can be used to block and wait in a test method until the provided assert action does not throw an exception, or until the timeout is reached (the default timeout is one second).</p>
<div class="NOTE">
<h5>Note</h5>
<p>The <code>WaitForAssertion()</code> method will try the assert action pass to it when the <code>WaitForAssertion()</code> method is called and every time the component under test renders.</p>
</div>
<p>Let us look at an example. Consider the following <code>&lt;AsyncData&gt;</code> component, who awaits an async <code>TextService</code> in its <code>OnInitializedAsync()</code> life-cycle method. When the service returns the data, the component will automatically re-render to update its rendered markup.</p>
<pre><code class="lang-cshtml" name="AsyncData.razor">&lt;p&gt;@text&lt;/p&gt;

@code
{
  string text = string.Empty;
  [Parameter] public Task&lt;string&gt; TextService { get; set; }

  protected override async Task OnInitializedAsync()
  {
    text = await TextService;
  }
}
</code></pre>
<p>To test the <code>&lt;AsyncData&gt;</code> component, do the following:</p>
<pre><code class="lang-csharp" name="AsyncDataTest.cs" highlight-lines="3,9,12">// Arrange
using var ctx = new TestContext();
var textService = new TaskCompletionSource&lt;string&gt;();
var cut = ctx.RenderComponent&lt;AsyncData&gt;(parameters =&gt; parameters
  .Add(p =&gt; p.TextService, textService.Task)
);

// Act - set the awaited result from the text service
textService.SetResult(&quot;Hello World&quot;);

// Wait for assertion to pass
cut.WaitForAssertion(() =&gt; cut.MarkupMatches(&quot;&lt;p&gt;Hello World&lt;/p&gt;&quot;));
</code></pre>
<p>This is what happens in the test:</p>
<ol>
<li>The test uses a <code>TaskCompletionSource&lt;string&gt;</code> to simulate an async web service.</li>
<li>In the second highlighted line, the result is provided to the component through the <code>textService</code>. This causes the component to re-render.</li>
<li>Finally, in the third highlighted line, the <code>WaitForAssertion()</code> method is used to block the test until the predicate assertion action runs without throwing an exception.</li>
</ol>
<h3 id="controlling-wait-timeout">Controlling Wait Timeout</h3>
<p>The timeout, which defaults to one second, can be controlled by passing a <code>TimeSpan</code> as the second argument to the <code>WaitForAssertion()</code> method, e.g.:</p>
<pre><code class="lang-csharp">cut.WaitForAssertion(() =&gt; cut.MarkupMatches(&quot;&lt;p&gt;Hello World&lt;/p&gt;&quot;), TimeSpan.FromSeconds(2));
</code></pre>
<p>If the timeout is reached, a <a class="xref" href="../../api/Bunit.Extensions.WaitForHelpers.WaitForFailedException.html">WaitForFailedException</a> exception is thrown with the following error message:</p>
<blockquote>
<p>The assertion did not pass within the timeout period.</p>
</blockquote>
<p>Setting the timeout to something less than one second does <em>not</em> make tests run faster. The <code>WaitForAssertion()</code> method returns as soon as it observes the predicate assertion running without throwing. So, it is generally only useful to set a different timeout than the default if the asynchronous operations takes longer than one second to complete, which should only be an issue in end-2-end or integration-testing scenarios.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="sponsor-highlight">
                <a href="https://www.telerik.com/campaigns/blazor/free-trial-1?utm_source=egilhansen&utm_medium=cpm&utm_campaign=blazor-trial-bunit-sponsored-message">
                  <img width="200" src="/sponsors/telerik-ad-site.svg">
                </a>      
              </div>
              <div class="supported">
                <a href="https://www.packtpub.com/" title="Packt">
                  <img width="150" src="/sponsors/packt-retina-logo.png">
                </a>
                <p>Editorial support provided by <a href="https://www.packtpub.com/" title="Packt">Packt</a>.</p>
              </div>
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/egil/bUnit/blob/main/docs/site/docs/verification/async-assertion.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            <small>Documentation updated on 1/7/2021 10:12:43 PM +00:00 in commit 242633e9ef</small>.
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/cshtml-razor.js"></script>
    <script>
      hljs.registerLanguage('cshtml-razor', window.hljsDefineCshtmlRazor);
    </script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
